# 健康分析功能说明

## 📋 功能概述

访谈系统现在集成了 AI 健康分析功能，可以在访谈结束后自动生成专业的健康评估报告。

## 🎯 功能特点

### 1. **自动分析**
- 访谈完成后自动触发 AI 分析
- 基于 Step API 的大语言模型
- 无需人工干预，全自动生成报告

### 2. **多维度评估**
- ✅ 整体健康状况评估
- ✅ 健康评分（0-100）
- ✅ 主要健康关注点识别
- ✅ 生活方式评估（睡眠、运动、饮食、压力）
- ✅ 风险因素分析
- ✅ 个性化健康建议
- ✅ 就医指导建议

### 3. **报告输出**
生成两种格式的报告：
- **JSON 格式**：`health_analysis.json` - 结构化数据，便于程序处理
- **文本格式**：`health_report.txt` - 易读的格式化报告

## 🚀 使用方法

### 运行访谈程序
```bash
cd /Users/town/code4/questionAgent
python interview_client_hybrid.py
```

### 访谈流程
1. 程序播放健康咨询问题
2. 用户语音回答问题
3. 访谈完成后，**自动生成 AI 健康分析报告**
4. 报告保存在 `sessions/[session_id]/` 目录

## 📁 文件结构

访谈完成后，会话目录包含：

```
sessions/20251119_HHMMSS/
├── session.json           # 原始访谈数据
├── summary.txt           # 访谈文本摘要
├── health_analysis.json  # AI 分析结果（JSON）
└── health_report.txt     # 健康报告（文本）
```

## 📊 报告示例

### 文本报告格式

```
======================================================================
📋 健康访谈分析报告
======================================================================

📊 访谈统计
   • 问题总数: 7
   • 已回答数: 7
   • 完成率: 100.0%

🏥 整体健康状况: ⚠️ FAIR
📈 健康评分: 65/100

📝 综合评估
   根据访谈结果，您的整体健康状况为一般水平。主要问题集中在睡眠质量和运动
   习惯方面，建议重点改善...

⚠️  主要健康关注点
   1. 睡眠质量不佳，每晚仅 5-6 小时
   2. 缺乏定期运动
   3. 工作压力较大

🌟 生活方式评估
   💤 睡眠: 睡眠时间不足，质量欠佳
   🏃 运动: 几乎不运动，需要建立运动习惯
   🥗 饮食: 未提供详细信息
   😌 压力: 工作压力较大，需要缓解

🚨 识别的风险因素
   1. 长期睡眠不足可能影响免疫力和心理健康
   2. 缺乏运动增加心血管疾病风险

💡 健康改进建议
   1. 建立规律作息，争取每晚 7-8 小时睡眠
   2. 每周至少 3 次，每次 30 分钟中等强度运动
   3. 学习压力管理技巧，如冥想、深呼吸
   4. 定期体检，监测健康指标
   5. 保持营养均衡的饮食

🏥 就医建议
   建议进行全面体检，特别关注睡眠质量相关指标。如持续失眠，
   建议咨询睡眠专科医生。

======================================================================
⚠️  免责声明：本报告仅供参考，不构成医疗诊断或治疗建议。
   如有健康问题，请咨询专业医疗机构。
======================================================================
```

## 🔧 技术实现

### 核心组件

1. **`health_analyzer_client.py`**
   - 健康分析客户端
   - 调用 Step API 进行 AI 分析
   - 格式化报告输出

2. **`health_analyzer_mcp.py`**
   - MCP 服务器实现（可选）
   - 提供标准化的 MCP 接口
   - 支持更复杂的集成场景

3. **`interview_client_hybrid.py`**
   - 集成了分析功能的访谈客户端
   - 在 `_complete_interview()` 中自动调用分析

4. **`question_manager.py`**
   - 新增 `save_analysis_report()` 方法
   - 新增 `get_answers_for_analysis()` 方法

### AI 分析流程

```
访谈结束
    ↓
收集问答数据
    ↓
调用 Step API (step-2-16k)
    ↓
AI 分析生成报告
    ↓
格式化输出
    ↓
保存到文件
    ↓
显示给用户
```

## ⚙️ 配置说明

### API Key 配置

确保设置了环境变量：
```bash
export STEPFUN_API_KEY='your-api-key-here'
```

### 分析参数

在 `health_analyzer_client.py` 中可以调整：
- **模型**：`step-2-16k`（当前使用）
- **温度**：`0.3`（较低，确保分析的稳定性和专业性）
- **超时时间**：`60` 秒

## 🎨 自定义分析

### 修改分析维度

编辑 `health_analyzer_client.py` 中的 `system_prompt`：

```python
system_prompt = """你是一位专业的健康顾问...

请从以下几个维度进行分析：
1. 你想要的分析维度1
2. 你想要的分析维度2
...
"""
```

### 修改报告格式

编辑 `health_analyzer_client.py` 中的 `format_report()` 方法。

## 🧪 独立测试

可以单独测试健康分析功能：

```bash
python health_analyzer_client.py
```

这会运行内置的测试示例。

## 📝 注意事项

1. **API 费用**：每次分析会调用 Step API，会产生 token 消费
2. **网络要求**：需要稳定的网络连接
3. **隐私保护**：访谈数据会发送到 Step API 进行分析
4. **免责声明**：AI 生成的报告仅供参考，不构成医疗建议

## 🔮 未来扩展

可能的增强功能：
- [ ] 历史对比：对比多次访谈结果，追踪健康趋势
- [ ] 风险预警：设置阈值，自动提醒高风险项
- [ ] 报告分享：生成 PDF 或邮件发送给医生
- [ ] 个性化建议：基于用户画像提供更精准的建议
- [ ] 多语言支持：支持英文等其他语言
- [ ] 可视化：生成健康评分图表

## 🆘 故障排查

### 问题：分析失败

**可能原因**：
1. API Key 未设置或无效
2. 网络连接问题
3. API 限流或配额不足

**解决方法**：
- 检查环境变量：`echo $STEPFUN_API_KEY`
- 检查网络连接
- 查看错误信息详细内容

### 问题：报告不准确

**可能原因**：
1. 回答信息不足
2. 回答模糊或不清晰
3. AI 理解偏差

**解决方法**：
- 鼓励用户提供更详细的回答
- 调整问题设计，更有针对性
- 修改 system_prompt 提供更多上下文

## 📞 技术支持

如有问题，请查看：
- 主文档：`README.md`
- 快速开始：`QUICKSTART.md`
- 混合模式说明：`README_HYBRID.md`

